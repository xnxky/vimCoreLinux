from mincemeatpy import mincemeat
import os

dataDirPath = "/home/xxiao/class/webIntelligence/hw3data"
datasource = dict((fileName, os.path.join(dataDirPath, fileName)) for fileName in os.listdir(dataDirPath))


def mapfn(k, v):
    from collections import defaultdict
    from stopwords import allStopWords
    import re
    count = defaultdict(int)
    for line in open(v):
        (docId, authors, title) = line.split(":::")
        for word in title.split():
            word = re.sub("[^0-9a-zA-Z]", "", word).lower()
            if(word in allStopWords or len(word) <=1):
                continue
            word = word.replace("-", " ")
            for author in authors.split("::"):
                count[(author, word)] += 1
    for key, value in count.iteritems():
        yield (key[0], (key[1], value))


def reducefn(k, vs):
    from collections import defaultdict
    count = defaultdict(int)
    for v in vs:
        count[v[0]] += int(v[1])
    sortedCount = sorted(count.iteritems(), key=lambda x: x[1])
    strOutput = [key+":"+str(value) for key, value in sortedCount]
    return k+"=>"+",".join(strOutput)+"\n"


s = mincemeat.Server()
s.datasource = datasource
s.mapfn = mapfn
s.reducefn = reducefn


results = s.run_server(password='hello')
print '\n'.join(results.values())
